name: Deploy Backend to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '.github/workflows/main.yml'

env:
  AZURE_WEBAPP_NAME: app-promed-backend-prod-dev
  AZURE_CR_NAME: promedhealthdashboard
  IMAGE_NAME: backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.AZURE_CR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and Push Docker Image
        run: |
          IMAGE_LATEST="${{ env.AZURE_CR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
          TAG_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_SHA="${{ env.AZURE_CR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${TAG_SHA}"
          
          echo "=========================================="
          echo "Building Docker Image"
          echo "=========================================="
          echo "Latest tag: $IMAGE_LATEST"
          echo "SHA tag: $IMAGE_SHA"
          echo "=========================================="
          
          docker build \
            --platform linux/amd64 \
            -t "$IMAGE_LATEST" \
            -t "$IMAGE_SHA" \
            .
          
          echo "Pushing latest tag to ACR..."
          docker push "$IMAGE_LATEST"
          
          echo "Pushing SHA tag to ACR..."
          docker push "$IMAGE_SHA"
          
          echo "=========================================="
          echo "Push Complete!"
          echo "=========================================="
          
          echo "IMAGE_TO_DEPLOY=$IMAGE_LATEST" >> $GITHUB_ENV

      - name: Azure Login for Deployment
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Verify Image in ACR
        run: |
          echo "Verifying images in ACR..."
          az acr repository show-tags \
            --name ${{ env.AZURE_CR_NAME }} \
            --repository ${{ env.IMAGE_NAME }} \
            --orderby time_desc \
            --top 10 \
            --output table
      
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.IMAGE_TO_DEPLOY }}
      
      - name: Deployment Complete
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Successful!"
          echo "=========================================="
          echo "App Name: ${{ env.AZURE_WEBAPP_NAME }}"
          echo "Image Deployed: ${{ env.IMAGE_TO_DEPLOY }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo ""
          echo "üîç View logs in Azure Portal:"
          echo "https://portal.azure.com"
          echo ""
          echo "Or use Azure CLI:"
          echo "az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group rg-promed-backend-prod-dev"
          echo "=========================================="
      
      - name: Logout of Azure
        run: az logout
        if: always()